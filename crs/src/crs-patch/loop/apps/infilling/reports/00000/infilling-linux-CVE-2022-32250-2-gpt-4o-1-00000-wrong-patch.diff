--- net/netfilter/nf_tables_api.c
+++ net/netfilter/nf_tables_api.c
@@ -3053,12 +3053,16 @@
 	int err;
 
 	err = nf_tables_expr_parse(ctx, nla, &expr_info);
-	if (err < 0)
-		goto err_expr_parse;
 
 	err = -ENOMEM;
 	expr = kzalloc(expr_info.ops->size, GFP_KERNEL_ACCOUNT);
-	if (expr == NULL)
+	if (!expr)
+		goto err_expr_stateful;
+
+	if (!(expr_info.ops->type->flags & NFT_EXPR_STATEFUL)) {
+		err = -EOPNOTSUPP;
+		goto err_expr_stateful;
+	}
 		goto err_expr_stateful;
 
 	err = nf_tables_newexpr(ctx, &expr_info, expr);
@@ -5824,9 +5828,6 @@
 		return expr;
 
 	err = -EOPNOTSUPP;
-	if (!(expr->ops->type->flags & NFT_EXPR_STATEFUL))
-		goto err_set_elem_expr;
-
 	if (expr->ops->type->flags & NFT_EXPR_GC) {
 		if (set->flags & NFT_SET_TIMEOUT)
 			goto err_set_elem_expr;


--- net/netfilter/nf_tables_api.c
+++ net/netfilter/nf_tables_api.c
@@ -3055,6 +3055,10 @@
 	err = nf_tables_expr_parse(ctx, nla, &expr_info);
 	if (err < 0)
 		goto err_expr_parse;
+
+	err = -EOPNOTSUPP;
+	if (!(expr_info.ops->type->flags & NFT_EXPR_STATEFUL))
+		goto err_expr_stateful;
 
 	err = -ENOMEM;
 	expr = kzalloc(expr_info.ops->size, GFP_KERNEL_ACCOUNT);
@@ -5821,15 +5825,21 @@
 
 	expr = nft_expr_init(ctx, attr);
 	if (IS_ERR(expr))
-		return expr;
-
-	err = -EOPNOTSUPP;
-	if (!(expr->ops->type->flags & NFT_EXPR_STATEFUL))
-		goto err_set_elem_expr;
-
-	if (expr->ops->type->flags & NFT_EXPR_GC) {
-		if (set->flags & NFT_SET_TIMEOUT)
+
+```c
+		if (!(expr->ops->type->flags & NFT_EXPR_STATEFUL) || 
+		    (expr->ops->type->flags & NFT_EXPR_GC && set->flags & NFT_SET_TIMEOUT))
 			goto err_set_elem_expr;
+		if (expr->ops->type->flags & NFT_EXPR_GC) {
+			set->ops->gc_init(set);
+		}
+	}
+	return expr;
+
+err_set_elem_expr:
+	nft_expr_destroy(ctx, expr);
+	return ERR_PTR(err);
+```
 		if (!set->ops->gc_init)
 			goto err_set_elem_expr;
 		set->ops->gc_init(set);
