#define _GNU_SOURCE
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <arpa/inet.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <time.h>
#include <unistd.h>
#include <errno.h>
#include <sys/ioctl.h>
#include <sys/syscall.h>

#define O_NOTIFICATION_PIPE 0x80
#define IOC_WATCH_QUEUE_SET_FILTER 0x5761
#define IOC_WATCH_QUEUE_SET_SIZE 0x5760

int harness( uint8_t *blob, uint32_t blob_size)
{
    int index = 0, fd = -1;
    uint32_t command, command_count = 0;
    uint32_t size = 0;
    int pipefds[2];

    if ( blob == NULL ) {
        return -1;
    }
    if(pipe2(pipefds, O_NOTIFICATION_PIPE)) return -1;
    fd = pipefds[0];

    memcpy(&command_count, blob, 4);
    index += 4;

    printf("[INFO] Executing %d commands\n", command_count);

    for ( uint32_t i = 0; i < command_count; i++) {
        if ( blob_size - index < 4 ) {
            close(fd);
            return -1;
        }
        memcpy(&command, blob + index, 4);
        index += 4;
        switch  (command) {
          case 0:
            if ( blob_size - index < 4 ) {
                close(fd);
                return -1;
            }
            memcpy(&size, blob + index, 4);
            index += 4;
            ioctl(fd, IOC_WATCH_QUEUE_SET_SIZE, size);
            break;
          case 1:
            if ( blob_size - index < 4 ) {
                close(fd);
                return -1;
            }
            memcpy(&size, blob + index, 4);
            index += 4;
            if ( blob_size - index < size ) {
                close(fd);
                return -1;
            }
            ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, (void*)(blob + index));
            index += size;
            break;
          default:
            printf("[ERROR] Unknown command: %x\n", command);
            return -1;
        }
    }
    return 0;
}

int main(int argc, char *argv[])
{
    char *blob = NULL;
    struct stat st;
    int fd;

    if (argc < 2) {
        printf("Need file\n");
        return -1;
    }

    if ( stat(argv[1], &st) != 0) {
        printf("Failed to stat file\n");
        return -1;
    }

    fd = open(argv[1], O_RDONLY);

    if ( fd < 0 ) {
        printf("[ERROR] Failed to open file\n");
        return -1;
    }

    blob = malloc(st.st_size);

    if ( blob == NULL ) {
        return 0;
    }

    read(fd, blob, st.st_size);

    close(fd);

    harness(blob, st.st_size);

    return 0;
}
