
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <attr/xattr.h>
#include <sys/ioctl.h>
#include <linux/loop.h>

#define IMG_SIZE (2*1024*1024) // 2MB
#define BUF_SIZE 4096

int createEmptyFile(const char *path, size_t size) {
    FILE *file = fopen(path, "wb");
    if (!file) {
        perror("fopen");
        return -1;
    }

    if (ftruncate(fileno(file), size) == -1) {
        perror("ftruncate");
        fclose(file);
        return -1;
    }

    fclose(file);
    return 0;
}

int main() {
    char buf[4096];
    int fd, loopFd;
    struct loop_info64 loopinfo;
    FILE *file = fopen("/tmp/ext4.img", "wb");
    if (!file) {
        perror("fopen");
        return -1;
    }

    if (ftruncate(fileno(file), IMG_SIZE) == -1) {
        perror("ftruncate");
        fclose(file);
        return -1;
    }

    fclose(file);
    
    printf("mkfs.ext4 ext4.img\n");
    // Hard to make C code for ext4 init
    system("mkfs.ext4 /tmp/ext4.img");
    
    printf("mkdir ext4\n");
    mkdir("/tmp/ext4", 0755);

    fd = open("/tmp/ext4.img", O_RDWR);
    if (fd < 0) {
        perror("open image file");
        exit(1);
    }

    loopFd = open("/dev/loop1", O_RDWR);
    if (loopFd < 0) {
        perror("open loop device");
        close(fd);
        exit(1);
    }

    memset(&loopinfo, 0, sizeof(loopinfo));
    strncpy((char*)loopinfo.lo_file_name, "/tmp/ext4.img", LO_NAME_SIZE);
    loopinfo.lo_flags = LO_FLAGS_AUTOCLEAR;

    if (ioctl(loopFd, LOOP_SET_FD, fd) < 0) {
        perror("ioctl LOOP_SET_FD");
        close(fd);
        close(loopFd);
        exit(1);
    }

    if (ioctl(loopFd, LOOP_SET_STATUS64, &loopinfo) < 0) {
        perror("ioctl LOOP_SET_STATUS64");
        ioctl(loopFd, LOOP_CLR_FD, 0);
        close(fd);
        close(loopFd);
        exit(1);
    }

    printf("mount -o debug_want_extra_isize=128 /dev/loop1 /tmp/ext4\n");
    if (mount("/dev/loop1", "/tmp/ext4", "ext4", MS_RELATIME, "debug_want_extra_isize=128") < 0) {
        perror("mount");
        exit(1);
    }
    
    printf("touch /tmp/ext4/file\n");
    fd = open("/tmp/ext4/file", O_CREAT | O_WRONLY, 0666);
    if (fd < 0) {
        perror("open file");
        exit(1);
    }
    close(fd);

    for (int i=0; i<100; i++) {
	printf("umount\n");
        if (umount("/tmp/ext4") < 0) {
            perror("umount");
            exit(1);
        }
	
	printf("mount\n");
        if (mount("/dev/loop1", "/tmp/ext4", "ext4", MS_RELATIME, "debug_want_extra_isize=128") < 0) {
            perror("mount");
            exit(1);
        }

        memset(buf,  'x', BUF_SIZE);
        printf("setxattr\n");
	if (setxattr("/tmp/ext4/file", "user.cat", buf, BUF_SIZE, 0) < 0) {
            perror("setxattr");
            exit(1);
        }
    }

    printf("Operation completed.\n");

    return 0;
}
