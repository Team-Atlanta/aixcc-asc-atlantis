#define _GNU_SOURCE
#include <unistd.h>
#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <sys/ioctl.h>
#include <sys/syscall.h>

#define O_NOTIFICATION_PIPE 0x80
#define IOC_WATCH_QUEUE_SET_FILTER	0x5761
struct watch_notification_type_filter {
	uint32_t	type;			/* Type to apply filter to */
	uint32_t	info_filter;		/* Filter on watch_notification::info */
	uint32_t	info_mask;		/* Mask of relevant bits in info_filter */
	uint32_t	subtype_filter[8];	/* Bitmask of subtypes to filter on */
};

struct watch_notification_filter {
	uint32_t	nr_filters;		/* Number of filters */
	uint32_t	__reserved;		/* Must be 0 */
	struct watch_notification_type_filter filters[];
};

int main(void) {
  int pipefds[2];
  if (pipe2(pipefds, O_NOTIFICATION_PIPE))
    err(1, "pipe2");
  int pfd = pipefds[0];

  struct watch_notification_filter *filter =
    malloc(sizeof(struct watch_notification_filter) +
           sizeof(struct watch_notification_type_filter));
  filter->nr_filters = 1;
  filter->__reserved = 0;
  filter->filters[0] = (struct watch_notification_type_filter){ .type = 511 };
  if (ioctl(pfd, IOC_WATCH_QUEUE_SET_FILTER, filter))
    err(1, "SET_FILTER");
}
