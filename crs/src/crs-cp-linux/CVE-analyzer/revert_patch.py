#!/usr/bin/python

import sys,os
import re
from pygments.lexers import get_lexer_by_name
from pygments.token import Token
import subprocess
def run_cmd(command):
    """Runs a system command and returns its output."""
    result = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    return result.stdout, result.stderr

def get_parent(kernel_dir, commit_sha):
    cmd = ["cd", kernel_dir, "&&", "git", "log", commit_sha, "-n", "1", "--pretty=format:%P"]
    print(cmd)
    return run_cmd(cmd)

def get_subject(commit_sha):
    cmd = ["git", "log", commit_sha, "-n", "1", "--pretty=format:%s"]
    return run_cmd(cmd)

def get_message(commit_sha):
    cmd = ["git", "log", commit_sha, "-n", "1", "--pretty=format:%B"]
    return run_cmd(cmd)

def revert_patch(kernel_dir, commit_sha, cve_num):
    get_parent_sha_cmd = "cd "+kernel_dir + " && git log "+commit_sha+" -n 1 --pretty=format:%P"
    (parent_sha, err) = run_cmd(get_parent_sha_cmd)
    get_patch_revert_cmd = "cd "+kernel_dir + " && git diff "+commit_sha+" "+parent_sha
    print(get_patch_revert_cmd)
    #cmd = ["cd", kernel_dir, "&&", "git", "diff", commit_sha, parent_sha]
    (result, err) = run_cmd(get_patch_revert_cmd)
    #print(result)
    if len(result) != 0:
        outfile = open("patch-revert/"+cve_num+"_"+commit_sha+"_patch-revert.diff", "w")
        outfile.write(result)
        outfile.close()
def main(argv):
    kernel_dir = argv[1]
    commit_num = argv[2]
    cve_num = argv[3]
    revert_patch(kernel_dir, commit_num, cve_num)
if __name__ == "__main__":
    main(sys.argv)